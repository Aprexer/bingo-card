<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
    <title>Bingo App with Database</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            --grid-max-width: 650px;
            --gap-size: clamp(3px, 1vw, 5px);
            --border-color: #333;
            --mark-button-size: clamp(22px, 6vw, 28px);
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px 15px; 
            min-height: 100vh; 
            background-color: #f0f0f0;
            -webkit-tap-highlight-color: transparent;
        }
        #bingo-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: var(--grid-max-width);
            margin: 0 auto;
        }
        h1 {
            font-size: clamp(1.8rem, 8vw, 2.5rem);
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }
        
        /* --- COLLAPSIBLE DATABASE SECTION --- */
        .database-section {
            width: 100%;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #ccc;
            overflow: hidden;
        }
        .database-section .database-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            user-select: none; /* Prevents text selection on tap */
        }
        .database-section h2 {
            font-size: clamp(1.1rem, 5vw, 1.2rem);
            margin: 0;
            color: #333;
        }
        .toggle-arrow {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        .database-section.expanded .toggle-arrow {
            transform: rotate(180deg);
        }
        .database-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease;
        }
        .database-section.expanded .database-content {
            max-height: 300px; /* Allow space for content to show */
            transition: max-height 0.4s ease-in;
        }
        #item-database {
            width: 100%;
            min-height: 150px;
            padding: 0 15px 15px 15px;
            font-size: 1rem;
            border: none;
            resize: vertical;
            display: block;
            box-sizing: border-box;
        }
        #item-database:focus {
            outline: none;
        }
        
        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
        button {
            padding: 15px 10px;
            font-size: clamp(0.9rem, 4vw, 1rem);
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            flex-grow: 1;
            flex-basis: 0;
        }
        button:active { transform: scale(0.98); }
        #populate-button { background-color: #9b59b6; color: white; }
        #save-button { background-color: #4CAF50; color: white; }
        #clear-button { background-color: #f44336; color: white; }
        #download-button { background-color: #008CBA; color: white; }

        #full-bingo-grid {
            display: grid;
            grid-template-columns: 1fr repeat(5, 2.5fr);
            grid-template-rows: 1fr repeat(5, 2.5fr);
            gap: var(--gap-size);
            border: 2px solid var(--border-color);
            background-color: var(--border-color);
            padding: var(--gap-size);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            width: 100%;
            aspect-ratio: 1 / 1;
        }
        .bingo-corner-empty { background-color: #f0f0f0; }
        .bingo-header { display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: clamp(1rem, 5vw, 1.75rem); background-color: #e74c3c; color: #fff; }
        .bingo-square { background-color: #fff; display: flex; font-size: clamp(0.7rem, 3.5vw, 1rem); text-align: center; position: relative; overflow: hidden; }
        .bingo-square .text-span { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; word-break: break-word; padding: 5px; padding-top: 15px; }
        .bingo-square .text-span:focus { outline: none; }
        .bingo-square:focus-within { box-shadow: 0 0 0 3px #008CBA inset; z-index: 10; }
        .mark-toggle { position: absolute; top: 5px; right: 5px; width: var(--mark-button-size); height: var(--mark-button-size); background-color: #e0e0e0; border: 1px solid #ccc; border-radius: 50%; cursor: pointer; z-index: 5; transition: background-color 0.2s ease; }
        .mark-toggle:hover { background-color: #c8c8c8; }
        .bingo-square.marked .mark-toggle { background-color: #4CAF50; border: 1px solid #388E3C; }
        .bingo-square.marked::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #4CAF50; opacity: 0.25; pointer-events: none; }
    </style>
</head>
<body>

    <div id="bingo-container">
        <h1>Bingo Card</h1>

        <div class="database-section" id="database-section">
            <div class="database-toggle" id="database-toggle">
                <h2>Item Database</h2>
                <span class="toggle-arrow">â–¼</span>
            </div>
            <div class="database-content">
                <textarea id="item-database" placeholder="Enter one item per line..."></textarea>
            </div>
        </div>
        
        <div class="buttons">
            <button id="populate-button">Populate Randomly</button>
            <button id="save-button">Save</button>
            <button id="clear-button">Clear</button>
            <button id="download-button">Download</button>
        </div>
        
        <div id="full-bingo-grid">
            <div class="bingo-corner-empty"></div> 
            <div class="bingo-header">B</div>
            <div class="bingo-header">I</div>
            <div class="bingo-header">N</div>
            <div class="bingo-header">G</div>
            <div class="bingo-header">O</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get all interactive elements
            const databaseSection = document.getElementById('database-section');
            const databaseToggle = document.getElementById('database-toggle');
            const itemDatabase = document.getElementById('item-database');
            const populateButton = document.getElementById('populate-button');
            const saveButton = document.getElementById('save-button');
            const clearButton = document.getElementById('clear-button');
            const downloadButton = document.getElementById('download-button');
            const fullBingoGrid = document.getElementById('full-bingo-grid');
            
            const numRows = 5, numCols = 5, totalSquares = numRows * numCols;
            const letters = ['B', 'I', 'N', 'G', 'O'];

            // --- Create the Bingo Grid ---
            for (let r = 0; r < numRows; r++) {
                const sideHeader = document.createElement('div');
                sideHeader.classList.add('bingo-header', 'side');
                sideHeader.textContent = letters[r];
                fullBingoGrid.appendChild(sideHeader);
                for (let c = 0; c < numCols; c++) {
                    const squareCounter = r * numCols + c;
                    const square = document.createElement('div');
                    square.classList.add('bingo-square');
                    square.setAttribute('id', `square-${squareCounter}`);
                    const textSpan = document.createElement('div');
                    textSpan.setAttribute('contenteditable', 'true');
                    textSpan.classList.add('text-span');
                    const markButton = document.createElement('div');
                    markButton.classList.add('mark-toggle');
                    markButton.addEventListener('click', (e) => { e.stopPropagation(); square.classList.toggle('marked'); });
                    square.appendChild(markButton);
                    square.appendChild(textSpan);
                    if (squareCounter === 12) { 
                        textSpan.textContent = 'FREE';
                        textSpan.setAttribute('contenteditable', 'false');
                        square.classList.add('free-space', 'marked');
                    }
                    fullBingoGrid.appendChild(square);
                }
            }
            
            // --- NEW: Collapsible Section Logic ---
            databaseToggle.addEventListener('click', () => {
                const isExpanded = databaseSection.classList.toggle('expanded');
                localStorage.setItem('databaseState', isExpanded ? 'expanded' : 'collapsed');
            });

            // --- Populate Functionality ---
            const shuffleArray = (array) => { /* ... (shuffle logic remains the same) */ return array.sort(() => Math.random() - 0.5); };
            const populateCard = () => {
                const items = itemDatabase.value.split('\n').map(item => item.trim()).filter(item => item);
                if (items.length < totalSquares - 1) {
                    alert(`Please add at least ${totalSquares - 1} items to the database to fully populate the card.`);
                    return;
                }
                const shuffledItems = shuffleArray(items);
                let itemIndex = 0;
                for (let i = 0; i < totalSquares; i++) {
                    if (i === 12) continue; // Skip FREE space
                    const textSpan = document.querySelector(`#square-${i} .text-span`);
                    textSpan.textContent = shuffledItems[itemIndex] || '';
                    itemIndex++;
                }
            };

            // --- Save, Load, Clear, Download ---
            const loadCard = () => {
                const savedDatabaseState = localStorage.getItem('databaseState');
                if (savedDatabaseState === 'expanded') {
                    databaseSection.classList.add('expanded');
                }
                const savedDatabase = localStorage.getItem('bingoDatabase');
                if (savedDatabase) { itemDatabase.value = savedDatabase; }
                const savedCardData = localStorage.getItem('bingoCardData');
                if (savedCardData) {
                    const cardData = JSON.parse(savedCardData);
                    for (let i = 0; i < totalSquares; i++) {
                        const square = document.getElementById(`square-${i}`);
                        const textSpan = square.querySelector('.text-span');
                        if (square && textSpan && cardData[i]) {
                            textSpan.textContent = cardData[i].text;
                            if (cardData[i].marked) { square.classList.add('marked'); } 
                            else { square.classList.remove('marked'); }
                        }
                    }
                }
            };

            const saveCard = () => {
                localStorage.setItem('bingoDatabase', itemDatabase.value);
                const cardData = [];
                for (let i = 0; i < totalSquares; i++) {
                    const square = document.getElementById(`square-${i}`);
                    const textSpan = square.querySelector('.text-span');
                    cardData.push({ text: textSpan.textContent, marked: square.classList.contains('marked') });
                }
                localStorage.setItem('bingoCardData', JSON.stringify(cardData));
                alert('Bingo card and database saved!');
            };

            const clearCard = () => {
                if (confirm('This will clear the bingo grid, but not your item database. Continue?')) {
                    for (let i = 0; i < totalSquares; i++) {
                        const square = document.getElementById(`square-${i}`);
                        const textSpan = square.querySelector('.text-span');
                        square.classList.remove('marked');
                        if (i === 12) {
                            textSpan.textContent = 'FREE';
                            square.classList.add('marked');
                        } else {
                            textSpan.textContent = '';
                        }
                    }
                    localStorage.removeItem('bingoCardData');
                }
            };
            
            const downloadHtml = () => {
                for (let i = 0; i < totalSquares; i++) {
                    const textSpan = document.querySelector(`#square-${i} .text-span`);
                    if (textSpan) { textSpan.innerHTML = textSpan.textContent; }
                }
                const docClone = document.documentElement.cloneNode(true);
                const databaseClone = docClone.getElementById('item-database');
                if (databaseClone) { databaseClone.textContent = itemDatabase.value; }
                const scriptTag = docClone.querySelector('script');
                if (scriptTag) { scriptTag.remove(); }
                const pageHtml = '<!DOCTYPE html>\n' + docClone.outerHTML;
                const blob = new Blob([pageHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'my-bingo-card.html';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };
            
            // --- Attach Event Listeners ---
            populateButton.addEventListener('click', populateCard);
            saveButton.addEventListener('click', saveCard);
            clearButton.addEventListener('click', clearCard);
            downloadButton.addEventListener('click', downloadHtml);
            
            loadCard(); // Load all data on start
        });
    </script>

</body>
</html>